<!-- Purpose: per-shop dev console. Called by GET /dev/shops/:publicId -->
<%- include('layout_header', { title: `${shop.label || shop.domain} - Shop Configuration | BLFS Dev` }) %>

<div class="mb-4">
    <a href="/dev" class="btn btn-sm btn-outline-secondary">‚Üê Back to Shops</a>
  </div>
  
  <h1 class="mb-4">
    <%= shop.label || shop.domain %>
    <% if (shop.label) { %>
      <small class="text-muted" style="font-size: 0.5em;">(<%= shop.domain %>)</small>
    <% } %>
  </h1>
  
  <% if (flash) { %>
    <div class="alert alert-<%= flash.kind === 'ok' ? 'success' : 'danger' %> alert-dismissible fade show" role="alert">
      <strong><%= flash.kind==='ok'?'Success':'Error' %>:</strong> <%= flash.text %>
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  <% } %>
  
  <div class="card mb-4">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-start mb-2">
        <div class="flex-grow-1">
          <p class="mb-0"><strong>Merchant Portal:</strong></p>
          <p class="font-monospace small text-break mb-0">https://<%= process.env.THIS_APP_DOMAIN %>/m/<%= shop.publicId %>/<%= shop.merchantUrlToken %>/overview</p>
        </div>
        <a href="/dev/shops/<%= shop.publicId %>/merchant-view" class="btn btn-sm btn-outline-primary ms-3" target="_blank">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-up-right" viewBox="0 0 16 16">
            <path fill-rule="evenodd" d="M8.636 3.5a.5.5 0 0 0-.5-.5H1.5A1.5 1.5 0 0 0 0 4.5v10A1.5 1.5 0 0 0 1.5 16h10a1.5 1.5 0 0 0 1.5-1.5V7.864a.5.5 0 0 0-1 0V14.5a.5.5 0 0 1-.5.5h-10a.5.5 0 0 1-.5-.5v-10a.5.5 0 0 1 .5-.5h6.636a.5.5 0 0 0 .5-.5z"/>
            <path fill-rule="evenodd" d="M16 .5a.5.5 0 0 0-.5-.5h-5a.5.5 0 0 0 0 1h3.793L6.146 9.146a.5.5 0 1 0 .708.708L15 1.707V5.5a.5.5 0 0 0 1 0v-5z"/>
          </svg>
          View Portal (Dev)
        </a>
      </div>
      <small class="text-muted">Share this URL and credentials with the merchant for read-only access to their orders.</small>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0">Merchant Data & Credentials</h5>
    </div>
    <div class="card-body">
      <form id="editShopForm" method="post" action="/dev/shops/<%= shop.publicId %>/shopify/credentials">
        <div class="mb-3">
          <label class="form-label">Merchant Label</label>
          <input name="label" class="form-control" value="<%= shop.label %>" placeholder="e.g., Sonia Boyajian" required>
          <small class="form-text text-muted">A friendly name to identify this merchant</small>
        </div>
        
        <div class="mb-3">
          <label class="form-label">Merchant Username</label>
          <input name="merchantUser" class="form-control" value="<%= shop.merchantUser %>" placeholder="merchant username" required>
          <div class="invalid-feedback"></div>
          <small class="form-text text-muted">Max 20 chars, no spaces, letters/numbers/hyphens/underscores only</small>
        </div>
        
        <div class="mb-3">
          <label class="form-label">Merchant Shopify Domain</label>
          <input name="shopDomain" class="form-control" value="<%= shop.domain %>" placeholder="your-shop.myshopify.com" required>
          <div class="invalid-feedback"></div>
          <small class="form-text text-muted">Your Shopify store domain (must end with .myshopify.com). No https:// or trailing /</small>
        </div>
        
        <div class="mb-3">
          <label class="form-label">Merchant Logo URL (optional)</label>
          <input name="merchantLogoUrl" class="form-control" value="<%= shop.merchantLogoUrl || '' %>" placeholder="https://example.com/logo.png">
          <div class="invalid-feedback"></div>
          <small class="form-text text-muted">Must be a valid image URL (.png, .jpg, .webp, etc.)</small>
          <% if (shop.merchantLogoUrl) { %>
            <div class="mt-2">
              <img src="<%= shop.merchantLogoUrl %>" alt="Merchant Logo" style="max-width: 200px; max-height: 80px; object-fit: contain;" onerror="this.style.display='none';this.nextElementSibling.style.display='block'">
              <span style="display:none" class="text-danger small">‚ö†Ô∏è Failed to load image</span>
            </div>
          <% } %>
        </div>
        
        <div class="mb-3">
          <label class="form-label">Shopify Client ID</label>
          <input name="apiKey" class="form-control" placeholder="Shopify Client ID" value="<%= decryptedApiKey || '' %>">
        </div>
        
        <div class="mb-3">
          <label class="form-label">Shopify Client Secret</label>
          <input name="apiSecret" class="form-control <%= shop.shopifyApiSecret ? 'text-success fw-bold' : '' %>" placeholder="Shopify Client Secret" value="<%= shop.shopifyApiSecret ? 'Shopify Client Secret [SAVED ‚úì]' : '' %>">
        </div>
        
        <div class="mb-3">
          <label class="form-label">Partner CLI Token</label>
          <input name="partnerCliToken" class="form-control <%= shop.partnerCliToken ? 'text-success fw-bold' : '' %>" placeholder="Paste Partner CLI token" value="<%= shop.partnerCliToken ? 'Partner CLI Token [SAVED ‚úì]' : '' %>">
        </div>
        
        <hr class="my-3">
        
        <h6 class="mb-3">NWC (Nostr Wallet Connect)</h6>
        <% if (wc && wc.failedReadOnlyValidation) { %>
          <div class="alert alert-danger mb-3" role="alert">
            <strong>üö® SECURITY ERROR: NWC Wallet Has Write Capabilities</strong><br>
            <small>Your current NWC wallet supports payment operations (pay_invoice, pay_keysend, etc.). This is a security risk.</small><br>
            <small><strong>Action Required:</strong> Please provide a new READ-ONLY NWC connection that only supports make_invoice, lookup_invoice, and notifications.</small><br>
            <small class="text-muted mt-2">OAuth installation and deployment are disabled until this is resolved.</small>
          </div>
        <% } else if (wc) { %>
          <div class="alert alert-success mb-3" role="alert">
            <strong>‚úì NWC Connected and Active (Read-Only)</strong><br>
            <small>Relay: <code><%= (() => { try { const url = new URL(decryptedNwcUri || wc.nwcUri); return url.searchParams.get('relay') ? decodeURIComponent(url.searchParams.get('relay')).replace(/^https?:\/\//, '').replace(/^wss?:\/\//, '') : 'Unknown'; } catch(e) { return 'Unknown'; } })() %></code></small><br>
            <small>Status: <strong>Active and ready for payments</strong></small>
          </div>
        <% } else { %>
          <div class="alert alert-warning mb-3" role="alert">
            <strong>‚ö†Ô∏è NWC Not Connected</strong><br>
            <small>You need to connect your Nostr Wallet Connect URI to receive Lightning payments.</small>
          </div>
        <% } %>
        <div class="mb-3">
          <label class="form-label">NWC URI <% if (wc) { %>(leave blank to keep current)<% } %></label>
          <input name="nwcUri" class="form-control" placeholder="nostr+walletconnect://..." <% if (!wc) { %>required<% } %>>
          <div class="invalid-feedback"></div>
          <small class="form-text text-muted">Must start with nostr+walletconnect:// and include relay parameter</small>
        </div>
        
        <button id="editShopBtn" type="submit" class="btn btn-primary">Update Merchant</button>
      </form>
      
      <script src="/static/validation.js"></script>
      <script>
        setupFormValidation('editShopForm', {
          'merchantUser': 'merchantUsername',
          'shopDomain': 'shopifyDomain',
          'merchantLogoUrl': 'logoUrl',
          'nwcUri': 'nwcUri'
        }, 'editShopBtn');
      </script>
      
      <hr class="my-4">
      
      <details>
        <summary style="cursor:pointer;color:#0d6efd;font-weight:500">Update Merchant Portal Link</summary>
        <div style="margin-top:16px">
          <button type="button" class="btn btn-success btn-sm me-2 mb-2" onclick="if(confirm('Generate new random password? This will show the password once and cannot be retrieved again.')) { document.getElementById('passwordForm').submit(); }">Generate new random password (show once)</button>
          <button type="button" class="btn btn-warning btn-sm mb-2" onclick="if(confirm('Rotate portal link token? This will invalidate the current merchant portal URL.')) { document.getElementById('rotateForm').submit(); }">Rotate portal link token</button>
        </div>
      </details>
      
      <form id="passwordForm" method="post" action="/dev/shops/<%= shop.publicId %>/merchant/reset-password" style="display:none">
        <input name="merchantUser" value="<%= shop.merchantUser %>">
      </form>
      <form id="rotateForm" method="post" action="/dev/shops/<%= shop.publicId %>/merchant/rotate-link" style="display:none"></form>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-header bg-info text-white">
      <h5 class="mb-0">OAuth & Deployment</h5>
    </div>
    <div class="card-body">
      <h6>Step 1: OAuth Installation</h6>
      <% const oauthReady = shop.shopifyApiKey && shop.shopifyApiSecret && shop.label && shop.merchantUser && shop.domain && wc && !wc.failedReadOnlyValidation; %>
      <form id="oauthForm" method="get" action="/dev/shops/<%= shop.publicId %>/admin-oauth/start" style="margin-top:12px" onsubmit="document.getElementById('oauthBtn').innerHTML='<span class=\'spinner-border spinner-border-sm me-2\'></span>Installing...'; document.getElementById('oauthBtn').disabled=true;">
        <input type="hidden" name="shop" value="<%= shop.domain %>">
        <button id="oauthBtn" type="submit" class="btn btn-outline-primary" <% if (!oauthReady) { %>disabled title="<%= !shop.label || !shop.merchantUser || !shop.domain ? 'Complete all merchant fields first' : (!shop.shopifyApiKey || !shop.shopifyApiSecret ? 'Save Shopify credentials first' : (!wc ? 'Connect NWC wallet first' : (wc.failedReadOnlyValidation ? 'Fix NWC read-only validation error first' : 'Prerequisites not met'))) %>"<% } %>>Start OAuth install</button>
      </form>
      <% if (shop.shopifyAccessToken) { %>
        <div class="text-success mt-2">‚úì OAuth completed and app installed</div>
      <% } else if (!oauthReady) { %>
        <div class="alert alert-warning mt-3" role="alert">
          <strong>Prerequisites needed before OAuth:</strong>
          <ul class="mb-0 mt-2">
            <% if (!shop.label) { %><li>Enter Merchant Label</li><% } %>
            <% if (!shop.merchantUser) { %><li>Enter Merchant Username</li><% } %>
            <% if (!shop.domain) { %><li>Enter Shopify Domain</li><% } %>
            <% if (!shop.shopifyApiKey || !shop.shopifyApiSecret) { %><li>Save Shopify credentials</li><% } %>
            <% if (!wc) { %><li>Connect NWC wallet</li><% } %>
            <% if (wc && wc.failedReadOnlyValidation) { %><li class="text-danger"><strong>Fix NWC read-only validation error</strong></li><% } %>
          </ul>
        </div>
      <% } %>
      
      <hr class="my-4">
      
      <h6>Step 2: Deploy Checkout Extension</h6>
      <% const readyToDeploy = shop.label && shop.merchantUser && shop.domain && shop.shopifyApiKey && shop.shopifyApiSecret && shop.partnerCliToken && wc && !wc.failedReadOnlyValidation; %>
      <form id="deployForm" method="post" action="/dev/shops/<%= shop.publicId %>/partner-cli/deploy" style="margin-top:12px" onsubmit="document.getElementById('deployBtn').innerHTML='<span class=\'spinner-border spinner-border-sm me-2\'></span>Deploying...'; document.getElementById('deployBtn').disabled=true;">
        <button id="deployBtn" type="submit" class="btn <%= readyToDeploy ? 'btn-success' : 'btn-secondary' %>" <% if (!readyToDeploy) { %>disabled title="<%= (wc && wc.failedReadOnlyValidation) ? 'Fix NWC read-only validation error first' : (!wc ? 'Connect NWC wallet first' : 'Complete all steps above first') %>"<% } %>>Deploy/Update Checkout UI extension</button>
      </form>
      <% if (!readyToDeploy) { %>
        <div class="alert alert-warning mt-3" role="alert">
          <strong>Prerequisites needed:</strong>
          <ul class="mb-0 mt-2">
            <% if (!shop.label) { %><li>Enter Merchant Label</li><% } %>
            <% if (!shop.merchantUser) { %><li>Enter Merchant Username</li><% } %>
            <% if (!shop.domain) { %><li>Enter Shopify Domain</li><% } %>
            <% if (!shop.shopifyApiKey || !shop.shopifyApiSecret) { %><li>Save Shopify credentials</li><% } %>
            <% if (!shop.partnerCliToken) { %><li>Save Partner CLI token</li><% } %>
            <% if (!wc) { %><li>Connect NWC wallet</li><% } %>
            <% if (wc && wc.failedReadOnlyValidation) { %><li class="text-danger"><strong>Fix NWC read-only validation error</strong></li><% } %>
          </ul>
        </div>
      <% } else if (shop.lastDeployedAt) { %>
        <div class="text-success mt-2">
          ‚úì Last deployed: <%= new Date(shop.lastDeployedAt).toLocaleString('en-US', { 
            month: 'short', 
            day: 'numeric', 
            year: 'numeric', 
            hour: 'numeric', 
            minute: '2-digit',
            hour12: true 
          }) %>
        </div>
      <% } else { %>
        <div class="text-success mt-2">‚úì Ready to deploy! All prerequisites completed.</div>
      <% } %>
    </div>
  </div>

  <% const fullyReady = shop.shopifyApiKey && shop.shopifyApiSecret && shop.shopifyAccessToken && shop.partnerCliToken && wc && !wc.failedReadOnlyValidation; %>
  <% if (fullyReady) { %>
    <!-- <div class="alert alert-success text-center" role="alert">
      <h4 class="alert-heading">üéâ Setup Complete!</h4>
      <p class="mb-0">Your shop is fully configured and ready to accept Lightning payments via Shopify checkout.</p>
    </div> -->
  <% } else { %>
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">Setup Progress</h5>
      </div>
      <div class="card-body">
        <ul class="list-unstyled mb-0">
          <li class="<%= (shop.label && shop.merchantUser && shop.domain) ? 'text-success' : 'text-muted' %> mb-2">
            <%= (shop.label && shop.merchantUser && shop.domain) ? '‚úì' : '‚óã' %> Merchant information complete
          </li>
          <li class="<%= shop.shopifyApiKey && shop.shopifyApiSecret ? 'text-success' : 'text-muted' %> mb-2">
            <%= shop.shopifyApiKey && shop.shopifyApiSecret ? '‚úì' : '‚óã' %> Shopify credentials saved
          </li>
          <li class="<%= (wc && !wc.failedReadOnlyValidation) ? 'text-success' : ((wc && wc.failedReadOnlyValidation) ? 'text-danger' : 'text-muted') %> mb-2">
            <%= (wc && !wc.failedReadOnlyValidation) ? '‚úì' : ((wc && wc.failedReadOnlyValidation) ? '‚úó' : '‚óã') %> NWC wallet connected (read-only) <%= (wc && wc.failedReadOnlyValidation) ? '‚ö†Ô∏è VALIDATION FAILED' : '' %>
          </li>
          <li class="<%= shop.shopifyAccessToken ? 'text-success' : 'text-muted' %> mb-2">
            <%= shop.shopifyAccessToken ? '‚úì' : '‚óã' %> OAuth completed and app installed
          </li>
          <li class="<%= shop.partnerCliToken ? 'text-success' : 'text-muted' %>">
            <%= shop.partnerCliToken ? '‚úì' : '‚óã' %> Partner CLI token saved
          </li>
        </ul>
      </div>
    </div>
  <% } %>

  <div class="card border-danger mb-4">
    <div class="card-header bg-danger text-white">
      <h5 class="mb-0">Danger Zone</h5>
    </div>
    <div class="card-body">
      <h6 class="text-danger">Delete Merchant</h6>
      <p class="text-muted small mb-3">This will permanently delete the merchant and all associated orders. This action cannot be undone.</p>
      <button type="button" class="btn btn-danger" onclick="if(confirm('Are you sure you want to delete this merchant? This will permanently delete the merchant and ALL associated orders. This action cannot be undone.\n\nType the merchant username to confirm: <%= shop.merchantUser %>')) { if(prompt('Please type the merchant username to confirm deletion:') === '<%= shop.merchantUser %>') { window.location.href='/dev/shops/<%= shop.publicId %>/delete'; } else { alert('Incorrect username. Deletion cancelled.'); } }">Delete Merchant</button>
    </div>
  </div>

<%- include('layout_footer') %>